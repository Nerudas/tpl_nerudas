(function(a){a(document).ready(function(){var b=setInterval(function(){var e=Joomla.getOptions("profileMap",""),c=e.selector,d=false;a("#"+c).height(Math.round((a("#"+c).width()/4)*3));if(a("#"+c).width()>0&&a("#"+c).height()>0){clearInterval(b);ymaps.ready(function(){var j=localStorage.getItem("map"),h={};if(j){j=a.parseJSON(j)}else{j={latitude:e.latitude,longitude:e.longitude,center:e.center,zoom:e.zoom};localStorage.setItem("map",JSON.stringify(j))}h=j;d=new ymaps.Map(c,{center:h.center,zoom:h.zoom,controls:["zoomControl","fullscreenControl","geolocationControl"]});var i=0,g=0;function f(){var k=[];k.push({name:"filter[author_id]",value:e.author_id});if(i==0){a.ajax({type:"GET",dataType:"json",url:"/index.php?option=com_board&task=map.getItemsTotal",data:k,success:function(l){var m=l.data;i=m;if(m>0){f()}}})}if(i>0){k.push({name:"limitstart",value:g});itemsRequest=a.ajax({type:"GET",dataType:"json",url:"/index.php?option=com_board&task=map.getItems",data:k,success:function(m){if(m.success){var n=m.data,l=n.placemarks;a.each(l,function(r,q){var s=a.parseJSON(q.coordinates),p={};if(q.options){a.each(q.options,function(t,u){if(t=="customLayout"){t="iconLayout";u=ymaps.templateLayoutFactory.createClass(u)}p[t]=u})}else{p.iconLayout="default#image";p.iconImageHref="/media/plg_fieldtypes_map/images/placemark.png";p.iconImageSize=[48,48];p.iconImageOffset=[-24,-48]}var o=new ymaps.Placemark(s,{},p);d.geoObjects.add(o);if(q.link){o.events.add("click",function(){window.open(q.link,"_blank")})}});g=g+n.count;d.setBounds(d.geoObjects.getBounds(),{checkZoomRange:true,zoomMargin:100});if(g<i){f()}}}})}}f();d.events.add("boundschange",function(m){if(m.get("newZoom")!=m.get("oldZoom")){var l=m.get("newZoom");h.zoom=l}if(m.get("newCenter")!=m.get("oldCenter")){var o=m.get("newCenter")[0].toFixed(6),n=m.get("newCenter")[1].toFixed(6),k=[o,n];h.center=k;h.latitude=o;h.longitude=n}localStorage.setItem("map",JSON.stringify(h))})})}},3)})})(jQuery);